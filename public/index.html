<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chautari - Chat Rooms</title>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
  <div id="chat-app">
    <!-- Sidebar with room list -->
    <div id="sidebar">
      <h2>Rooms</h2>
      <div id="room-list">
        <div class="room-item active" data-room="public">General</div>
        <!-- Private rooms will be appended here -->
      </div>
    </div>

    <!-- Main chat area -->
    <div id="chat-area">
      <div id="chat-header">
        <h2 id="current-room-title">General Chat</h2>
      </div>
      <div id="messages"></div>
      <form id="message-form">
        <input id="message-input" type="text" placeholder="Type a message..." autocomplete="off" required/>
        <button type="submit">Send</button>
      </form>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    // DOM elements
    const roomList = document.getElementById("room-list");
    const messagesContainer = document.getElementById("messages");
    const currentRoomTitle = document.getElementById("current-room-title");
    const messageForm = document.getElementById("message-form");
    const messageInput = document.getElementById("message-input");

    // User & room state
    let currentUser = prompt("Enter your username:") || "Anonymous";
    let currentRoom = "public";
    let chatHistory = {};
    let roomNotifications = {};

    // ---- Core functions ----
    function addMessage(msg) {
      if (!chatHistory[msg.room]) chatHistory[msg.room] = [];
      chatHistory[msg.room].push(msg);

      if (msg.room === currentRoom) {
        renderMessage(msg);
      }
    }

    function renderMessage(msg) {
      const div = document.createElement("div");
      div.classList.add("message");
      if (msg.user === "System") div.classList.add("system");
      if (msg.user === currentUser) div.classList.add("self");

      div.innerHTML = `
        <div class="message-content">
          <div class="message-sender">${msg.user}</div>
          <div class="message-text">${msg.text}</div>
        </div>
      `;
      messagesContainer.appendChild(div);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function renderChat(room) {
      messagesContainer.innerHTML = "";
      if (chatHistory[room]) {
        chatHistory[room].forEach(renderMessage);
      }
    }

    function switchRoom(room) {
      currentRoom = room;
      currentRoomTitle.textContent = room === "public" ? "General Chat" : room;

      // Update sidebar active state
      document.querySelectorAll(".room-item").forEach(item => {
        item.classList.toggle("active", item.dataset.room === room);
      });

      // Clear + restore chat for that room
      renderChat(room);

      // Reset notifications
      roomNotifications[room] = 0;
      updateRoomNotifications();

      // Tell server we joined
      socket.emit("joinRoom", { username: currentUser, room });
    }

    function updateRoomNotifications() {
      document.querySelectorAll(".room-item").forEach(item => {
        const room = item.dataset.room;
        const count = roomNotifications[room] || 0;
        item.textContent = room === "public" ? "General" : room;
        if (count > 0 && room !== currentRoom) {
          item.textContent += ` (${count})`;
        }
      });
    }

    // ---- Socket events ----
    socket.emit("joinRoom", { username: currentUser, room: currentRoom });

    socket.on("chatMessage", msg => {
      addMessage(msg);

      if (msg.room !== currentRoom) {
        if (!roomNotifications[msg.room]) roomNotifications[msg.room] = 0;
        roomNotifications[msg.room]++;
        updateRoomNotifications();
      }
    });

    socket.on("privateRoomCreated", room => {
      if (!document.querySelector(`[data-room="${room}"]`)) {
        const div = document.createElement("div");
        div.classList.add("room-item");
        div.dataset.room = room;
        div.textContent = room;
        roomList.appendChild(div);

        div.addEventListener("click", () => switchRoom(room));
      }
    });

    // ---- Event listeners ----
    messageForm.addEventListener("submit", e => {
      e.preventDefault();
      const text = messageInput.value.trim();
      if (!text) return;

      const msg = { user: currentUser, text, room: currentRoom };
      socket.emit("chatMessage", msg);
      messageInput.value = "";
    });

    // Make General room clickable again
    document.querySelectorAll(".room-item").forEach(item => {
      item.addEventListener("click", () => {
        const room = item.dataset.room;
        switchRoom(room);
      });
    });
  </script>
</body>
</html>