<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chautari</title>
<style>
:root {
  --primary-color: #698550;
  --secondary-color: #749157;
  --background-color: #f8f9fa;
  --sidebar-bg: #698550;
  --message-bg: #ffffff;
  --system-message: #e6f0d5;
  --private-message: #e6f7ee;
  --text-color: #333;
  --light-text: #666;
  --border-color: #dde5cc;
  --online-status: #4caf50;
  --away-status: #ff9800;
  --notification: #e74c3c;
  --self-message: #b0e68a;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
  color: var(--text-color);
  height: 100vh;
  display: flex;
  flex-direction: column;
}

.app-container {
  display: flex;
  height: 100%;
}

/* Sidebar Styles */
.sidebar {
  width: 250px;
  background: linear-gradient(180deg, var(--sidebar-bg) 0%, #5a7248 100%);
  color: white;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
}

.user-profile {
  padding: 20px;
  background-color: rgba(0, 0, 0, 0.1);
  text-align: center;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.user-avatar {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background-color: var(--secondary-color);
  margin: 0 auto 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  font-weight: bold;
  color: white;
}

.user-name {
  font-weight: bold;
  margin-bottom: 5px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.user-status {
  font-size: 0.8rem;
  color: #d4e6b3;
}

.rooms-section, .users-section {
  padding: 15px;
}

.section-title {
  font-size: 0.9rem;
  text-transform: uppercase;
  margin-bottom: 15px;
  color: #d4e6b3;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.room-list, .user-list {
  list-style: none;
}

.room-item, .user-item {
  padding: 10px;
  margin-bottom: 5px;
  border-radius: 5px;
  cursor: pointer;
  display: flex;
  align-items: center;
  transition: background-color 0.2s;
}

.room-item:hover, .user-item:hover {
  background-color: rgba(255, 255, 255, 0.1);
  transform: translateX(5px);
  transition: all 0.2s ease;
}

.room-item.active {
  background-color: #5a7248;
}

.room-icon {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  background-color: var(--secondary-color);
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 10px;
  font-weight: bold;
  color: white;
}

.room-name {
  flex: 1;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  color: white;
}

.room-notification {
  background-color: var(--notification);
  color: white;
  font-size: 0.7rem;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}

.user-avatar-sm {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  background-color: var(--secondary-color);
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 10px;
  font-size: 0.8rem;
  font-weight: bold;
  color: rgb(216, 209, 209);
}

.user-name-txt {
  color: white;
}

.user-status-indicator {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  margin-left: auto;
}

.status-online {
  background-color: var(--online-status);
  animation: pulse 2s infinite;
}

.status-away {
  background-color: var(--away-status);
}

/* Chat Area Styles */
.chat-area {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* Section Tabs */
.section-tabs {
  display: flex;
  background-color: white;
  border-bottom: 1px solid var(--border-color);
  padding: 0 20px;
}

.section-tab {
  display: flex;
  align-items: center;
  padding: 15px 20px;
  cursor: pointer;
  border-bottom: 3px solid transparent;
  transition: all 0.2s;
  font-weight: 500;
  color: var(--light-text);
  gap: 8px;
}

.section-tab:hover {
  background-color: var(--background-color);
  color: var(--text-color);
}

.section-tab.active {
  color: var(--primary-color);
  border-bottom-color: var(--primary-color);
}

.section-tab svg {
  opacity: 0.7;
}

.section-tab.active svg {
  opacity: 1;
}

/* Section Content */
.section-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}


/* Posts Styles */
.posts-container {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  background-color: #f9fbf4;
}

.create-post {
  background-color: white;
  border-radius: 10px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
}

.post-input-area {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.post-title-input {
  border: 1px solid var(--border-color);
  border-radius: 6px;
  padding: 10px 15px;
  font-family: inherit;
  font-size: 1rem;
  outline: none;
}

.post-title-input:focus {
  border-color: var(--primary-color);
}

.post-text-input {
  border: 1px solid var(--border-color);
  border-radius: 8px;
  padding: 12px 15px;
  font-family: inherit;
  font-size: 1rem;
  resize: vertical;
  min-height: 100px;
  outline: none;
}

.post-text-input:focus {
  border-color: var(--primary-color);
}

.post-submit-btn {
  background-color: var(--primary-color);
  color: white;
  border: none;
  border-radius: 6px;
  padding: 10px 16px;
  font-weight: bold;
  cursor: pointer;
  align-self: flex-start;
  transition: background-color 0.2s;
}

.post-submit-btn:hover {
  background-color: #5a7248;
}

.post-submit-btn:disabled {
  background-color: var(--light-text);
  cursor: not-allowed;
}



/* Posts Styles */
.post {
  background-color: white;
  border-radius: 10px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
  animation: fadeIn 0.5s ease-out;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.post:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
}

.post-header {
  display: flex;
  align-items: center;
  margin-bottom: 15px;
}

.post-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: white;
  margin-right: 12px;
  flex-shrink: 0;
}

.post-info {
  flex: 1;
}

.post-user {
  font-weight: bold;
  color: var(--primary-color);
  margin-bottom: 2px;
}

.post-time {
  font-size: 0.8rem;
  color: var(--light-text);
}

.post-content {
  margin-bottom: 15px;
}

.post-title {
  font-size: 1.2rem;
  font-weight: bold;
  color: var(--primary-color);
  margin-bottom: 8px;
  line-height: 1.3;
}

.post-text {
  line-height: 1.5;
  color: var(--text-color);
  white-space: pre-wrap;
}

.post-actions {
  display: flex;
  gap: 20px;
  padding-top: 10px;
  border-top: 1px solid var(--border-color);
}

.comment-post-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  background: none;
  border: none;
  color: var(--light-text);
  cursor: pointer;
  padding: 8px 12px;
  border-radius: 6px;
  transition: all 0.2s;
  font-size: 0.9rem;
}

.comment-post-btn:hover {
  background-color: var(--background-color);
  color: var(--text-color);
}

/* Post Comments Styles */
.post-comments-section {
  margin-top: 15px;
  padding-top: 15px;
  border-top: 1px solid var(--border-color);
}

.post-comments-list {
  margin-bottom: 15px;
}

.post-comment {
  display: flex;
  margin-bottom: 12px;
  padding: 10px;
  background-color: var(--background-color);
  border-radius: 8px;
}

.post-comment-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: white;
  margin-right: 10px;
  flex-shrink: 0;
  font-size: 0.8rem;
}

.post-comment-content {
  flex: 1;
}

.post-comment-user {
  font-weight: bold;
  color: var(--primary-color);
  font-size: 0.9rem;
  margin-bottom: 2px;
}

.post-comment-text {
  line-height: 1.4;
  margin-bottom: 3px;
}

.post-comment-time {
  font-size: 0.7rem;
  color: var(--light-text);
}

.post-comment-input {
  display: flex;
  gap: 10px;
  align-items: center;
}

.post-comment-input-field {
  flex: 1;
  padding: 8px 12px;
  border: 1px solid var(--border-color);
  border-radius: 20px;
  outline: none;
  font-family: inherit;
  font-size: 0.9rem;
}

.post-comment-input-field:focus {
  border-color: var(--primary-color);
}

.post-comment-submit-btn {
  background-color: var(--primary-color);
  color: white;
  border: none;
  border-radius: 20px;
  padding: 8px 16px;
  font-weight: bold;
  cursor: pointer;
  font-size: 0.9rem;
  transition: background-color 0.2s;
}

.post-comment-submit-btn:hover {
  background-color: #5a7248;
}

.chat-header {
  padding: 15px 20px;
  background-color: white;
  border-bottom: 1px solid var(--border-color);
  display: flex;
  align-items: center;
  justify-content: space-between;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.room-title {
  font-weight: bold;
  font-size: 1.2rem;
  color: var(--primary-color);
}

.room-info {
  font-size: 0.9rem;
  color: var(--light-text);
}

.messages-container {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
  background-color: #f9fbf4;
}

.message {
  margin-bottom: 15px;
  display: flex;
  max-width: 80%;
  animation: slideIn 0.3s ease-out;
}

.message.self {
  margin-left: auto;
  flex-direction: row-reverse;
}

.message.system {
  max-width: 100%;
  justify-content: center;
}

.message.private {
  border-left: 3px solid var(--primary-color);
  padding-left: 5px;
}

.message-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background-color: var(--secondary-color);
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 10px;
  font-weight: bold;
  color: white;
  flex-shrink: 0;
}

.message-content {
  background-color: var(--message-bg);
  padding: 10px 15px;
  border-radius: 18px;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  max-width: 100%;
  overflow-wrap: break-word;
  word-break: break-word;
}

.message.system .message-content {
  background-color: var(--system-message);
  font-style: italic;
  color: #5a7248;
}

.message.private .message-content {
  background-color: var(--private-message);
  border: 1px solid #d4e6b3;
}

.message.self .message-content {
  background-color: var(--self-message);
}

.message-sender {
  font-weight: bold;
  margin-bottom: 3px;
  color: var(--primary-color);
}

.message-text {
  line-height: 1.4;
  max-width: 100%;
}

.message-time {
  font-size: 0.7rem;
  color: var(--light-text);
  margin-top: 3px;
  text-align: right;
}

.message.self .message-time {
  text-align: left;
}

.input-area {
  padding: 15px 20px;
  background-color: white;
  border-top: 1px solid var(--border-color);
  display: flex;
  align-items: center;
  box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.05);
}

.message-input {
  flex: 1;
  padding: 12px 15px;
  border: 1px solid var(--border-color);
  border-radius: 24px;
  outline: none;
  font-family: inherit;
  resize: none;
  max-height: 120px;
}

.message-input:focus {
  border-color: var(--primary-color);
}

.send-button {
  margin-left: 10px;
  background-color: var(--primary-color);
  color: white;
  border: none;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: background-color 0.2s;
}

.send-button:hover {
  background-color: #5a7248;
}

.send-button:disabled {
  background-color: var(--light-text);
  cursor: not-allowed;
}

/* Welcome Screen */
.welcome-screen {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.welcome-content {
  text-align: center;
  color: white;
  max-width: 500px;
  padding: 40px;
}

.welcome-title {
  font-size: 3rem;
  margin-bottom: 20px;
  font-weight: bold;
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
}

.welcome-subtitle {
  font-size: 1.2rem;
  margin-bottom: 40px;
  opacity: 0.9;
  line-height: 1.5;
}

.welcome-subtitle::before {
  content: "🌟 ";
}

.welcome-subtitle::after {
  content: " 🌟";
}

.welcome-button {
  background-color: white;
  color: var(--primary-color);
  border: none;
  padding: 15px 30px;
  font-size: 1.1rem;
  font-weight: bold;
  border-radius: 30px;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.welcome-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
  background: linear-gradient(135deg, #749157, #698550);
}

/* Login Modal */
.login-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.modal-content {
  background-color: white;
  padding: 30px;
  border-radius: 10px;
  width: 90%;
  max-width: 400px;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
}

.modal-title {
  margin-bottom: 20px;
  text-align: center;
  color: var(--primary-color);
}

.login-input {
  width: 100%;
  padding: 12px;
  margin-bottom: 15px;
  border: 1px solid var(--border-color);
  border-radius: 5px;
  font-family: inherit;
}

.login-button {
  width: 100%;
  padding: 12px;
  background-color: var(--primary-color);
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  font-family: inherit;
  font-weight: bold;
  transition: background-color 0.2s;
}

.login-button:hover {
  background-color: #5a7248;
}

/* Responsive Design */
@media (max-width: 768px) {
  .sidebar {
    width: 70px;
    overflow: visible;
  }
  
  .user-name, .room-name, .user-name-txt, .section-title span {
    display: none;
  }
  
  .user-profile, .rooms-section, .users-section {
    padding: 10px 5px;
    text-align: center;
  }
  
  .room-item, .user-item {
    justify-content: center;
    padding: 15px 5px;
  }
  
  .room-icon, .user-avatar-sm {
    margin-right: 0;
  }
  
  .room-notification {
    position: absolute;
    top: 5px;
    right: 5px;
  }
  
  .room-item, .user-item {
    position: relative;
  }
  
  .user-status-indicator {
    position: absolute;
    bottom: 5px;
    right: 5px;
  }
}

.new-message-notice {
  position: sticky;
  bottom: 10px;
  background-color: var(--primary-color);
  color: white;
  text-align: center;
  padding: 8px;
  border-radius: 20px;
  margin: 10px auto;
  width: 200px;
  cursor: pointer;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
  display: none;
}

.character-count {
  font-size: 0.8rem;
  color: var(--light-text);
  margin-right: 10px;
  min-width: 60px;
  text-align: right;
}

.character-count.limit {
  color: var(--notification);
  font-weight: bold;
}

/* Animations */
@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

@keyframes bounceIn {
  0% {
    opacity: 0;
    transform: scale(0.3);
  }
  50% {
    opacity: 1;
    transform: scale(1.05);
  }
  70% {
    transform: scale(0.9);
  }
  100% {
    opacity: 1;
    transform: scale(1);
  }
}

@keyframes pulse {
  0% {
    box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7);
  }
  70% {
    box-shadow: 0 0 0 10px rgba(76, 175, 80, 0);
  }
  100% {
    box-shadow: 0 0 0 0 rgba(76, 175, 80, 0);
  }
}
</style>
</head>
<body>
<div class="app-container">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="user-profile">
      <div class="user-avatar" id="userAvatar">U</div>
      <div class="user-name" id="sidebarUserName">Username</div>
      <div class="user-status" id="userStatus">Online</div>
    </div>
    
    <div class="rooms-section">
      <div class="section-title">
        <span>Rooms</span>
        <span>+</span>
      </div>
      <ul class="room-list" id="roomList">
        <li class="room-item active" data-room="public">
          <div class="room-icon">C</div>
          <div class="room-name">General</div>
          <div class="room-notification" style="display: none;">0</div>
        </li>
        <!-- Room items will be added dynamically -->
      </ul>
    </div>
    
    <div class="users-section">
      <div class="section-title">
        <span>Online Users</span>
        <span>●</span>
      </div>
      <ul class="user-list" id="userList">
        <!-- User items will be added dynamically -->
      </ul>
    </div>
  </div>
  
  <!-- Chat Area -->
  <div class="chat-area">
    <div class="chat-header">
      <div>
        <div class="room-title" id="currentRoomTitle">Chautari</div>
        <div class="room-info" id="roomInfo">0 users online</div>
      </div>
    </div>

    <!-- Section Tabs -->
    <div class="section-tabs">
      <div class="section-tab active" data-section="posts">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15a2 2 0 0 0-2 2H7l-4 4V5a2 2 0 0 0 2-2h14a2 2 0 0 0 2 2z"></path>
        </svg>
        Posts
      </div>
      <div class="section-tab" data-section="chat">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"></path>
        </svg>
        Public Chat
      </div>
    </div>


    <!-- Posts Section -->
    <div class="section-content" id="postsSection" style="display: none;">
      <div class="posts-container" id="postsContainer">
        <div class="create-post">
          <div class="post-input-area">
            <input type="text" class="post-title-input" id="postTitleInput" placeholder="Post title..." disabled>
            <textarea class="post-text-input" id="postTextInput" placeholder="Share something..." disabled></textarea>
            <button class="post-submit-btn" id="postSubmitBtn" disabled>Create Post</button>
          </div>
        </div>
        <!-- Threads will be added dynamically -->
      </div>
    </div>

    <!-- Public Chat Section -->
    <div class="section-content" id="chatSection" style="display: none;">
      <div class="messages-container" id="messagesContainer">
        <div class="message system">
          <div class="message-content">
            Welcome to Chautari Public Chat! Start chatting now.
          </div>
        </div>
        <!-- Messages will be added dynamically -->

        <div class="new-message-notice" id="newMessageNotice">New messages below!</div>
      </div>

      <div class="input-area">
        <span class="character-count" id="characterCount">0/500</span>
        <textarea class="message-input" id="messageInput" placeholder="Type a message..." disabled></textarea>
        <button class="send-button" id="sendButton" disabled>
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
          </svg>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Welcome Screen -->
<div class="welcome-screen" id="welcomeScreen">
  <div class="welcome-content">
    <h1 class="welcome-title">Welcome to Chautari</h1>
    <p class="welcome-subtitle">Connect, share, and discuss with people around the world</p>
    <button class="welcome-button" id="enterButton">Enter Chautari</button>
  </div>
</div>

<!-- Login Modal -->
<div class="login-modal" id="loginModal" style="display: none;">
  <div class="modal-content">
    <h2 class="modal-title">Join Chautari</h2>
    <input type="text" class="login-input" id="loginUsername" placeholder="Enter your name" autocomplete="off">
    <button class="login-button" id="loginButton">Join Chat</button>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
// DOM Elements
const messagesContainer = document.getElementById('messagesContainer');
const messageInput = document.getElementById('messageInput');
const sendButton = document.getElementById('sendButton');
const roomList = document.getElementById('roomList');
const userList = document.getElementById('userList');
const currentRoomTitle = document.getElementById('currentRoomTitle');
const roomInfo = document.getElementById('roomInfo');
const userAvatar = document.getElementById('userAvatar');
const sidebarUserName = document.getElementById('sidebarUserName');
const loginModal = document.getElementById('loginModal');
const loginUsername = document.getElementById('loginUsername');
const loginButton = document.getElementById('loginButton');
const newMessageNotice = document.getElementById('newMessageNotice');
const characterCount = document.getElementById('characterCount');
const welcomeScreen = document.getElementById('welcomeScreen');
const enterButton = document.getElementById('enterButton');
const sectionTabs = document.querySelectorAll('.section-tab');
const postsSection = document.getElementById('postsSection');
const chatSection = document.getElementById('chatSection');
const postTitleInput = document.getElementById('postTitleInput');
const postTextInput = document.getElementById('postTextInput');
const postSubmitBtn = document.getElementById('postSubmitBtn');

// App State
let currentUser = '';
let currentRoom = 'public';
let socket = null;
let userColors = {};
let roomNotifications = {};
let atBottom = true;
let chatHistory = {}; // Store chat history for each room

// Initialize the app
function initApp() {
  // Set up event listeners
  enterButton.addEventListener('click', showLoginModal);
  loginButton.addEventListener('click', handleLogin);
  loginUsername.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') handleLogin();
  });

  // Section tab event listeners
  sectionTabs.forEach(tab => {
    tab.addEventListener('click', () => switchSection(tab.dataset.section));
  });


  // Post submission event listener
  postSubmitBtn.addEventListener('click', createPost);

  sendButton.addEventListener('click', sendMessage);
  messageInput.addEventListener('input', updateCharacterCount);
  messageInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  messagesContainer.addEventListener('scroll', handleScroll);
  newMessageNotice.addEventListener('click', scrollToBottom);

  // Initialize room notifications and chat history
  roomNotifications['public'] = 0;
  chatHistory['public'] = [];
}

// Update character count
function updateCharacterCount() {
  const length = messageInput.value.length;
  characterCount.textContent = `${length}/500`;
  
  if (length >= 450) {
    characterCount.classList.add('limit');
  } else {
    characterCount.classList.remove('limit');
  }
  
  // Enable/disable send button based on message length
  sendButton.disabled = length === 0 || length > 500;
}

// Show login modal
function showLoginModal() {
  welcomeScreen.style.display = 'none';
  loginModal.style.display = 'flex';
  loginUsername.focus();
}

// Switch between sections
function switchSection(sectionName) {
  // Prevent switching sections in private rooms
  if (currentRoom && currentRoom.startsWith('private_')) {
    return;
  }

  // Update tab active states
  sectionTabs.forEach(tab => {
    tab.classList.remove('active');
  });
  document.querySelector(`[data-section="${sectionName}"]`).classList.add('active');

  // Hide all sections
  postsSection.style.display = 'none';
  chatSection.style.display = 'none';

  // Show selected section
  if (sectionName === 'posts') {
    postsSection.style.display = 'flex';
  } else if (sectionName === 'chat') {
    chatSection.style.display = 'flex';
  }
}



// Create a new post
function createPost() {
  const title = postTitleInput.value.trim();
  const text = postTextInput.value.trim();
  if (!title || !text) return;

  socket.emit('createPost', { title, text });
  clearPostForm();
}

// Clear post form
function clearPostForm() {
  postTitleInput.value = '';
  postTextInput.value = '';
}

// Display posts in the feed
function displayPosts(posts) {
  const postsContainer = document.getElementById('postsContainer');

  // Clear existing posts but keep the create post section
  const createPostSection = postsContainer.querySelector('.create-post');
  postsContainer.innerHTML = '';
  postsContainer.appendChild(createPostSection);

  // Add posts
  posts.forEach(post => {
    addPostToFeed(post);
  });
}

// Add a post to the feed
function addPostToFeed(post) {
  const postsContainer = document.getElementById('postsContainer');
  const createPostSection = postsContainer.querySelector('.create-post');
  const postEl = document.createElement('div');
  postEl.className = 'post';
  postEl.dataset.postId = post.id;

  const timestamp = new Date(post.timestamp).toLocaleString();

  postEl.innerHTML = `
    <div class="post-header">
      <div class="post-avatar" style="background-color: ${userColors[post.user] || '#749157'}">${post.user.charAt(0).toUpperCase()}</div>
      <div class="post-info">
        <div class="post-user">${post.user}</div>
        <div class="post-time">${timestamp}</div>
      </div>
    </div>
    <div class="post-content">
      <div class="post-title">${post.title}</div>
      <div class="post-text">${post.text}</div>
    </div>
    <div class="post-actions">
      <button class="comment-post-btn" onclick="togglePostComments(${post.id})">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"></path>
        </svg>
        ${post.comments.length} Comments
      </button>
    </div>
    <div class="post-comments-section" id="post-comments-${post.id}" style="display: none;">
      <div class="post-comments-list" id="post-comments-list-${post.id}">
        ${post.comments.map(comment => `
          <div class="post-comment">
            <div class="post-comment-avatar" style="background-color: ${userColors[comment.user] || '#749157'}">${comment.user.charAt(0).toUpperCase()}</div>
            <div class="post-comment-content">
              <div class="post-comment-user">${comment.user}</div>
              <div class="post-comment-text">${comment.text}</div>
              <div class="post-comment-time">${new Date(comment.timestamp).toLocaleString()}</div>
            </div>
          </div>
        `).join('')}
      </div>
      <div class="post-comment-input">
        <input type="text" class="post-comment-input-field" id="post-comment-input-${post.id}" placeholder="Add to the discussion..." onkeypress="handlePostCommentKeypress(event, ${post.id})">
        <button class="post-comment-submit-btn" onclick="addPostComment(${post.id})">Post</button>
      </div>
    </div>
  `;

  // Insert after the create post section
  if (createPostSection.nextSibling) {
    postsContainer.insertBefore(postEl, createPostSection.nextSibling);
  } else {
    postsContainer.appendChild(postEl);
  }
}

// Update a post in the feed
function updatePostInFeed(updatedPost) {
  const postEl = document.querySelector(`[data-post-id="${updatedPost.id}"]`);
  if (postEl) {
    const commentBtn = postEl.querySelector('.comment-post-btn');
    commentBtn.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"></path>
      </svg>
      ${updatedPost.comments.length} Comments
    `;

    // Update comments if visible
    const commentsList = postEl.querySelector(`#post-comments-list-${updatedPost.id}`);
    if (commentsList) {
      commentsList.innerHTML = updatedPost.comments.map(comment => `
        <div class="post-comment">
          <div class="post-comment-avatar" style="background-color: ${userColors[comment.user] || '#749157'}">${comment.user.charAt(0).toUpperCase()}</div>
          <div class="post-comment-content">
            <div class="post-comment-user">${comment.user}</div>
            <div class="post-comment-text">${comment.text}</div>
            <div class="post-comment-time">${new Date(comment.timestamp).toLocaleString()}</div>
          </div>
        </div>
      `).join('');
    }
  }
}

// Toggle post comments visibility
function togglePostComments(postId) {
  const commentsSection = document.getElementById(`post-comments-${postId}`);
  commentsSection.style.display = commentsSection.style.display === 'none' ? 'block' : 'none';
}

// Handle post comment keypress
function handlePostCommentKeypress(event, postId) {
  if (event.key === 'Enter') {
    addPostComment(postId);
  }
}

// Add a comment to a post
function addPostComment(postId) {
  const input = document.getElementById(`post-comment-input-${postId}`);
  const text = input.value.trim();
  if (!text) return;

  socket.emit('commentPost', { postId, text });
  input.value = '';
}

// Handle user login
function handleLogin() {
  const username = loginUsername.value.trim();
  if (!username) return;
  
  currentUser = username;
  userAvatar.textContent = username.charAt(0).toUpperCase();
  sidebarUserName.textContent = username;
  
  // Connect to socket.io
  socket = io();
  
  // Set up socket event listeners
  socket.on('connect', () => {
    console.log('Connected to server');
    socket.emit('joinRoom', { username, room: 'public' });
  });
  
  socket.on('chatMessage', (data) => {
    // Store message in history regardless of current room
    if (!chatHistory[data.room]) {
      chatHistory[data.room] = [];
    }
    chatHistory[data.room].push(data);
    
    // If message is for current room, display it
    if (data.room === currentRoom) {
      addMessageToChat(data);
    }
    
    // If message is from another room, show notification
    if (data.room !== currentRoom) {
      if (!roomNotifications[data.room]) {
        roomNotifications[data.room] = 0;
      }
      roomNotifications[data.room]++;
      updateRoomNotifications();
    }
  });
  
  socket.on('userList', (data) => {
    updateUserList(data.users, data.room);
  });
  
  socket.on('roomList', (data) => {
    updateRoomList(data.rooms);
  });
  
  socket.on('chatHistory', (data) => {
    // Store the chat history for this room
    chatHistory[data.room] = data.messages;

    // If this is the current room, display the history
    if (data.room === currentRoom) {
      messagesContainer.innerHTML = '';
      data.messages.forEach(msg => {
        addMessageToChat(msg);
      });
      scrollToBottom();

      // Ensure section tabs are visible for public room
      const sectionTabs = document.querySelector('.section-tabs');
      if (currentRoom === 'public') {
        sectionTabs.style.display = 'flex';
      }
    }
  });


  // Posts event listeners
  socket.on('newPost', (post) => {
    addPostToFeed(post);
  });

  socket.on('updatePost', (post) => {
    updatePostInFeed(post);
  });

  socket.on('postsData', (postsData) => {
    displayPosts(postsData);
  });

  // Get initial posts data
  socket.emit('getPosts');
  
  // Hide login modal and enable inputs
  loginModal.style.display = 'none';
  messageInput.disabled = false;
  postTitleInput.disabled = false;
  postTextInput.disabled = false;
  postSubmitBtn.disabled = false;

  // Focus on message input
  messageInput.focus();
}

// Send message to server
function sendMessage() {
  const text = messageInput.value.trim();
  if (!text || !socket || text.length > 500) return;
  
  socket.emit('chatMessage', { room: currentRoom, text });
  messageInput.value = '';
  messageInput.style.height = 'auto';
  updateCharacterCount();
}

// Add message to chat UI
function addMessageToChat(data) {
  const messageEl = document.createElement('div');
  const isSystem = data.user === 'System';
  const isSelf = data.user === currentUser;
  const isPrivate = data.room.startsWith('private_');
  
  messageEl.className = 'message';
  if (isSystem) messageEl.classList.add('system');
  if (isSelf) messageEl.classList.add('self');
  if (isPrivate) messageEl.classList.add('private');
  
  // Generate color for user if not exists
  if (!userColors[data.user] && !isSystem) {
    userColors[data.user] = generateColorFromString(data.user);
  }
  
  const timestamp = new Date(data.timestamp || Date.now()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  
  messageEl.innerHTML = `
    ${!isSystem ? `<div class="message-avatar" style="background-color: ${userColors[data.user]}">${data.user.charAt(0).toUpperCase()}</div>` : ''}
    <div class="message-content">
      ${!isSystem ? `<div class="message-sender">${data.user}</div>` : ''}
      <div class="message-text">${data.text}</div>
      <div class="message-time">${timestamp}</div>
    </div>
  `;
  
  messagesContainer.appendChild(messageEl);
  
  // Scroll to bottom if at bottom
  if (atBottom) {
    scrollToBottom();
  } else {
    newMessageNotice.style.display = 'block';
  }
}

// Update user list in sidebar
function updateUserList(users, room) {
  if (room !== currentRoom) return;
  
  userList.innerHTML = '';
  roomInfo.textContent = `${users.length} user${users.length !== 1 ? 's' : ''} online`;
  
  users.forEach(user => {
    if (user === currentUser) return;
    
    const userEl = document.createElement('li');
    userEl.className = 'user-item';
    userEl.dataset.user = user;
    
    userEl.innerHTML = `
      <div class="user-avatar-sm" style="background-color: ${userColors[user] || '#749157'}">${user.charAt(0).toUpperCase()}</div>
      <div class="user-name-txt">${user}</div>
      <div class="user-status-indicator status-online"></div>
    `;
    
    userEl.addEventListener('click', () => {
      createPrivateRoom(user);
    });
    
    userList.appendChild(userEl);
  });
}

// Update room list in sidebar
function updateRoomList(rooms) {
  // Keep the public room and add others
  const publicRoom = roomList.querySelector('[data-room="public"]');
  roomList.innerHTML = '';
  roomList.appendChild(publicRoom);
  
  // Add click event to public room
  publicRoom.addEventListener('click', () => {
    joinRoom('public');
  });
  
  rooms.forEach(room => {
    if (room === 'public') return;
    
    const roomEl = document.createElement('li');
    roomEl.className = 'room-item';
    roomEl.dataset.room = room;
    
    // Check if it's a private room
    const isPrivate = room.startsWith('private_');
    let roomName = room;
    let roomIcon = 'R';
    
    if (isPrivate) {
      const users = room.replace('private_', '').split('_');
      const otherUser = users.find(user => user !== currentUser);
      roomName = `Private: ${otherUser}`;
      roomIcon = otherUser.charAt(0).toUpperCase();
    }
    
    roomEl.innerHTML = `
      <div class="room-icon">${roomIcon}</div>
      <div class="room-name">${roomName}</div>
      <div class="room-notification" style="display: ${roomNotifications[room] > 0 ? 'flex' : 'none'};">${roomNotifications[room] || 0}</div>
    `;
    
    roomEl.addEventListener('click', () => {
      joinRoom(room);
    });
    
    roomList.appendChild(roomEl);
  });
  
  // Set active room
  const activeRoom = roomList.querySelector(`[data-room="${currentRoom}"]`);
  if (activeRoom) {
    activeRoom.classList.add('active');
  }
}

// Update room notifications
function updateRoomNotifications() {
  Object.keys(roomNotifications).forEach(room => {
    const notificationEl = roomList.querySelector(`[data-room="${room}"] .room-notification`);
    if (notificationEl) {
      notificationEl.textContent = roomNotifications[room];
      notificationEl.style.display = roomNotifications[room] > 0 ? 'flex' : 'none';
    }
  });
}

// Join a room
function joinRoom(room) {
  if (room === currentRoom) return;

  // Emit room leave and join events
  socket.emit('leaveRoom', { room: currentRoom });
  socket.emit('joinRoom', { username: currentUser, room });

  // Update current room
  currentRoom = room;

  // Update UI
  const roomItems = roomList.querySelectorAll('.room-item');
  roomItems.forEach(item => item.classList.remove('active'));

  const newRoomItem = roomList.querySelector(`[data-room="${room}"]`);
  if (newRoomItem) {
    newRoomItem.classList.add('active');
  }

  // Clear notifications for this room
  roomNotifications[room] = 0;
  updateRoomNotifications();

  // Update room title and section visibility
  const sectionTabs = document.querySelector('.section-tabs');
  if (room === 'public') {
    currentRoomTitle.textContent = 'Chautari';
    sectionTabs.style.display = 'flex'; // Show tabs for public room
  } else if (room.startsWith('private_')) {
    const users = room.replace('private_', '').split('_');
    const otherUser = users.find(user => user !== currentUser);
    currentRoomTitle.textContent = `Private: ${otherUser}`;
    sectionTabs.style.display = 'none'; // Hide tabs for private rooms
    // Automatically switch to chat section for private rooms
    switchSection('chat');
  } else {
    currentRoomTitle.textContent = room;
    sectionTabs.style.display = 'flex'; // Show tabs for other rooms
  }

  // Clear messages and load room history
  messagesContainer.innerHTML = '';

  // Load chat history for this room if it exists
  if (chatHistory[room] && chatHistory[room].length > 0) {
    chatHistory[room].forEach(msg => {
      addMessageToChat(msg);
    });
  } else {
    // Add welcome message if no history
    const welcomeMsg = document.createElement('div');
    welcomeMsg.className = 'message system';
    welcomeMsg.innerHTML = '<div class="message-content">You joined the room</div>';
    messagesContainer.appendChild(welcomeMsg);
  }

  scrollToBottom();
}

// Create a private room
function createPrivateRoom(otherUser) {
  const privateRoom = `private_${[currentUser, otherUser].sort().join('_')}`;
  
  // Check if room already exists
  if (!roomList.querySelector(`[data-room="${privateRoom}"]`)) {
    // Add to room list
    const roomEl = document.createElement('li');
    roomEl.className = 'room-item';
    roomEl.dataset.room = privateRoom;
    
    roomEl.innerHTML = `
      <div class="room-icon">${otherUser.charAt(0).toUpperCase()}</div>
      <div class="room-name">Private: ${otherUser}</div>
      <div class="room-notification" style="display: none;">0</div>
    `;
    
    roomEl.addEventListener('click', () => {
      joinRoom(privateRoom);
    });
    
    roomList.appendChild(roomEl);
  }
  
  // Join the room
  joinRoom(privateRoom);
}

// Handle scroll events
function handleScroll() {
  const threshold = 20;
  atBottom = messagesContainer.scrollTop + messagesContainer.clientHeight >= messagesContainer.scrollHeight - threshold;
  
  if (atBottom) {
    newMessageNotice.style.display = 'none';
  }
}

// Scroll to bottom of messages
function scrollToBottom() {
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
  newMessageNotice.style.display = 'none';
  atBottom = true;
}

// Generate color from string
function generateColorFromString(str) {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    hash = str.charCodeAt(i) + ((hash << 5) - hash);
  }
  
  const hue = hash % 360;
  return `hsl(${hue}, 65%, 65%)`;
}

// Initialize the app when DOM is loaded
document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>