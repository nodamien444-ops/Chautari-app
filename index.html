<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chautari</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      height: 100vh;
    }

    /* Sidebar for chat rooms */
    #rooms {
      width: 60px;
      background: #e0e0e0;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px 0;
      gap: 10px;
    }

    .roomBubble {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #ccc;
      cursor: pointer;
      font-weight: bold;
    }

    .roomBubble.active {
      background: #888;
      color: #fff;
    }

    /* Chat area */
    #chatArea {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    #messagesList {
      flex: 1;
      padding: 10px;
      margin: 0;
      list-style: none;
      overflow-y: auto;
      margin-bottom: 60px; /* leave space for fixed input */
    }

    #inputContainer {
      position: fixed;
      bottom: 0;
      left: 60px; /* offset for sidebar */
      right: 0;
      display: flex;
      padding: 10px;
      gap: 5px;
      background-color: #f0f0f0;
      border-top: 1px solid #ccc;
    }

    #inputContainer input {
      flex: 1;
      padding: 5px;
    }

    li span.username {
      font-weight: bold;
      margin-right: 5px;
    }
  </style>
</head>
<body>
  <!-- Sidebar with rooms -->
  <div id="rooms">
    <div class="roomBubble active" id="publicRoom">C</div>
  </div>

  <!-- Main chat area -->
  <div id="chatArea">
    <ul id="messagesList"></ul>

    <div id="inputContainer">
      <input id="username" placeholder="Your name">
      <input id="message" placeholder="Type message">
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

  <script>
    const messagesList = document.getElementById('messagesList');
    const messageInput = document.getElementById('message');
    const roomsDiv = document.getElementById('rooms');

    let currentRoom = "public";
    const userColors = {};

    function getRandomColor() {
      const hue = Math.floor(Math.random() * 360);
      return `hsl(${hue}, 70%, 50%)`;
    }

    async function sendMessage() {
      const user = document.getElementById('username').value || "Anonymous";
      const text = messageInput.value;
      if (!text) return;

      await fetch(`/messages/${currentRoom}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user, text })
      });

      messageInput.value = '';
      fetchMessages();
    }

    async function fetchMessages() {
      const res = await fetch(`/messages/${currentRoom}`);
      const messages = await res.json();
      messagesList.innerHTML = '';

      messages.forEach(msg => {
        if (!userColors[msg.user]) {
          userColors[msg.user] = getRandomColor();
        }
        const li = document.createElement('li');
        li.innerHTML = `<span class="username" style="color:${userColors[msg.user]}">${msg.user}:</span> ${msg.text}`;
        li.addEventListener('click', () => openPrivateChat(msg.user));
        messagesList.appendChild(li);
      });
    }

    function openPrivateChat(user) {
      if (user === "Anonymous") return;
      currentRoom = `private-${user}`;
      highlightRoomBubble(currentRoom);

      if (!document.getElementById(currentRoom)) {
        const bubble = document.createElement('div');
        bubble.className = 'roomBubble';
        bubble.id = currentRoom;
        bubble.textContent = user[0].toUpperCase();
        bubble.style.backgroundColor = userColors[user];
        bubble.onclick = () => switchRoom(currentRoom);
        roomsDiv.appendChild(bubble);
      }

      fetchMessages();
    }

    function switchRoom(room) {
      currentRoom = room;
      highlightRoomBubble(room);
      fetchMessages();
    }

    function highlightRoomBubble(room) {
      document.querySelectorAll('.roomBubble').forEach(b => b.classList.remove('active'));
      const activeBubble = document.getElementById(room === "public" ? "publicRoom" : room);
      if (activeBubble) activeBubble.classList.add('active');
    }

    // Refresh messages every 2s
    setInterval(fetchMessages, 2000);

    // Send message on Enter
    messageInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') sendMessage();
    });

    fetchMessages();
  </script>
</body>
</html>
