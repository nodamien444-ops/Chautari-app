<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chat</title>
  <style>
    body { font-family: Arial, sans-serif; background: #fafafa; }
    #chat { height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; }
    .msg { margin: 5px 0; }
    .username { font-weight: bold; color: blue; cursor: pointer; }
    #roomName { font-size: 14px; margin-bottom: 10px; font-style: italic; }
  </style>
</head>
<body>
  <div id="roomName">Room: public</div>
  <div id="chat"></div>
  <input id="msg" placeholder="Type message..." autocomplete="off">
  <button id="send">Send</button>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let username = prompt("Enter your name") || "Guest";
    let currentRoom = "public";

    // Join public room
    socket.emit("joinRoom", { username, room: currentRoom });

    const chat = document.getElementById("chat");
    const msgInput = document.getElementById("msg");
    const sendBtn = document.getElementById("send");
    const roomName = document.getElementById("roomName");

    function addMessage({ user, text }) {
      const div = document.createElement("div");
      div.classList.add("msg");
      div.innerHTML = `<span class="username">${user}</span>: ${text}`;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;

      // Click username to start private chat
      div.querySelector(".username").onclick = () => {
        if (user === "System" || user === username) return;
        startPrivateChat(user);
      };
    }

    socket.on("chatMessage", (msg) => {
      if (msg.room === currentRoom) {
        addMessage(msg);
      }
    });

    sendBtn.onclick = () => {
      const text = msgInput.value.trim();
      if (text) {
        socket.emit("chatMessage", { room: currentRoom, text });
        msgInput.value = "";
      }
    };

    function startPrivateChat(target) {
      const privateRoom = [username, target].sort().join("_");
      currentRoom = privateRoom;
      chat.innerHTML = "";
      roomName.innerText = `Room: Private with ${target}`;
      socket.emit("joinRoom", { username, room: privateRoom });
    }

    document.addEventListener("keydown", (e) => {
      if (e.key.toLowerCase() === "c") {
        currentRoom = "public";
        chat.innerHTML = "";
        roomName.innerText = "Room: public";
        socket.emit("joinRoom", { username, room: "public" });
      }
    });
  </script>
</body>
</html>
