<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chautari</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      height: 100vh;
    }

    /* Sidebar */
    #chatRooms {
      width: 60px;
      background: #f7f7f7;
      border-right: 1px solid #ccc;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px 0;
      gap: 10px;
    }

    .roomBubble {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .roomBubble:hover {
      transform: scale(1.1);
    }
    .roomBubble.active {
      border: 2px solid black;
    }

    /* Main Chat Area */
    #chatArea {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    h1 {
      text-align: center;
      margin: 10px 0;
    }

    #messagesList {
      flex: 1;
      padding: 10px;
      margin: 0;
      list-style: none;
      overflow-y: auto;
      margin-bottom: 60px; /* leave space for fixed input */
    }

    #inputContainer {
      position: fixed;
      bottom: 0;
      left: 60px; /* leave space for sidebar */
      right: 0;
      display: flex;
      padding: 10px;
      gap: 5px;
      background-color: #f0f0f0;
      border-top: 1px solid #ccc;
    }

    #inputContainer input {
      flex: 1;
      padding: 5px;
    }

    li span.username {
      font-weight: bold;
      margin-right: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div id="chatRooms">
    <div class="roomBubble active" id="publicRoom">C</div>
  </div>

  <!-- Main Chat -->
  <div id="chatArea">
    <h1>Chautari</h1>
    <ul id="messagesList"></ul>
    <div id="inputContainer">
      <input id="username" placeholder="Your name">
      <input id="message" placeholder="Type message">
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

  <script>
    const messagesList = document.getElementById('messagesList');
    const messageInput = document.getElementById('message');
    const chatRooms = document.getElementById('chatRooms');

    // Store colors per username
    const userColors = {};
    let currentRoom = "public"; // "public" or "private:<username>"

    function getRandomColor() {
      const hue = Math.floor(Math.random() * 360);
      return `hsl(${hue}, 70%, 40%)`; // readable colors
    }

    async function sendMessage() {
      const user = document.getElementById('username').value || "Anonymous";
      const text = messageInput.value;
      if (!text) return;

      await fetch('/messages', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user, text })
      });

      messageInput.value = '';
      fetchMessages();
    }

    async function fetchMessages() {
      const res = await fetch('/messages');
      const messages = await res.json();
      messagesList.innerHTML = '';

      messages.forEach(msg => {
        if (!userColors[msg.user]) {
          userColors[msg.user] = getRandomColor();
        }

        // Filter by room
        if (currentRoom === "public" || currentRoom === `private:${msg.user}`) {
          const li = document.createElement('li');
          const userSpan = document.createElement('span');
          userSpan.className = "username";
          userSpan.style.color = userColors[msg.user];
          userSpan.textContent = msg.user + ":";
          userSpan.onclick = () => openPrivateChat(msg.user);
          li.appendChild(userSpan);
          li.append(" " + msg.text);
          messagesList.appendChild(li);
        }
      });
    }

    function openPrivateChat(user) {
      const roomId = `private:${user}`;
      if (!document.getElementById(roomId)) {
        const bubble = document.createElement('div');
        bubble.className = "roomBubble";
        bubble.id = roomId;
        bubble.textContent = user[0].toUpperCase();
        bubble.style.backgroundColor = userColors[user];
        bubble.onclick = () => switchRoom(roomId);
        chatRooms.appendChild(bubble);
      }
      switchRoom(roomId);
    }

    function switchRoom(roomId) {
      currentRoom = roomId === "publicRoom" ? "public" : roomId;
      document.querySelectorAll('.roomBubble').forEach(b => b.classList.remove('active'));
      document.getElementById(roomId)?.classList.add('active');
      fetchMessages();
    }

    // Refresh messages every 2s
    setInterval(fetchMessages, 2000);

    // Send on Enter
    messageInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') sendMessage();
    });

    fetchMessages(); // initial load
  </script>
</body>
</html>
